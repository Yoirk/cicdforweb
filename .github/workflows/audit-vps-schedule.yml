name: VPS Security Audit

on:
  # Chạy tự động vào 00:00 Chủ Nhật hàng tuần
  schedule:
    - cron: '0 0 * * 0'
  # Cho phép chạy thủ công từ tab Actions để test
  workflow_dispatch:

jobs:
  audit-vps:
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Run Lynis
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            if ! command -v lynis &> /dev/null; then
                echo "Installing Lynis..."
                sudo apt-get update -q && sudo apt-get install lynis -y -q
            fi

            echo "Running Lynis Audit..."
            # Lưu kết quả vào file log
            sudo lynis audit system --quick > /tmp/lynis-report.log

            echo "================================================"
            echo "HARDENING INDEX REPORT"
            echo "================================================"
            grep "Hardening index" /tmp/lynis-report.log
            echo ""

            echo "================================================"
            echo "CRITICAL WARNINGS (Can Fix Ngay)"
            echo "================================================"
            # Lệnh này sẽ in ra dòng chứa chữ Warning kèm mô tả
            grep "Warning" /tmp/lynis-report.log || echo "No Warnings found."
            echo ""

            echo "================================================"
            echo "TOP 10 SUGGESTIONS (Lam Tu Tu)"
            echo "================================================"
            grep "Suggestion" /tmp/lynis-report.log | head -n 10
            
            # Dọn dẹp
            rm /tmp/lynis-report.log