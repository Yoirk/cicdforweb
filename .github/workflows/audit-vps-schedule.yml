name: VPS Security Audit

on:
  # Chạy tự động vào 00:00 Chủ Nhật hàng tuần
  schedule:
    - cron: '0 0 * * 0'
  # Cho phép chạy thủ công từ tab Actions để test
  workflow_dispatch:

jobs:
  audit-vps:
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Run Lynis
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Cài đặt Lynis nếu chưa có (Ubuntu/Debian)
            if ! command -v lynis &> /dev/null; then
                echo "Installing Lynis..."
                sudo apt-get update -q && sudo apt-get install lynis -y -q
            fi

            # 2. Chạy quét (System Audit)
            # --quick: Chạy không cần confirm
            echo "Running Lynis Audit..."
            sudo lynis audit system --quick > /tmp/lynis-report.log

            # 3. Hiển thị kết quả tóm tắt ra log của Github
            echo "------------------------------------------------"
            echo "SECURITY SCORE:"
            grep "Hardening index" /tmp/lynis-report.log
            echo "------------------------------------------------"
            
            echo "TOP 10 SUGGESTIONS:"
            grep "Suggestion" /tmp/lynis-report.log | head -n 10
            echo "------------------------------------------------"

            # 4. Kiểm tra cảnh báo nghiêm trọng
            WARNINGS=$(grep -c "Warning" /tmp/lynis-report.log)
            echo "Found $WARNINGS warnings."
            
            # Xóa file log sau khi xong
            rm /tmp/lynis-report.log