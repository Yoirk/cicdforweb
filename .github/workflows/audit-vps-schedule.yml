name: VPS Security Audit

on:
  # Chạy tự động vào 00:00 Chủ Nhật hàng tuần
  schedule:
    - cron: '0 0 * * 0'
  # Cho phép chạy thủ công từ tab Actions để test
  workflow_dispatch:

jobs:
  audit-vps:
    runs-on: ubuntu-latest
    steps:
      - name: SSH and Run Lynis
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            if ! command -v lynis &> /dev/null; then
                echo "Installing Lynis..."
                sudo apt-get update -q && sudo apt-get install lynis -y -q
            fi

            echo "Running Lynis Audit..."
            # --no-colors để log sạch sẽ dễ đọc hơn
            sudo lynis audit system --quick --no-colors > /tmp/lynis-report.log

            echo "================================================"
            echo "HARDENING INDEX REPORT"
            echo "================================================"
            grep "Hardening index" /tmp/lynis-report.log
            echo ""

            echo "================================================"
            echo "CRITICAL WARNINGS (CHI TIET)"
            echo "================================================"
            # Cách 1: Tìm dòng test cụ thể bị đánh dấu [ WARNING ]
            grep "\[ WARNING \]" /tmp/lynis-report.log || echo "No inline warnings found."
            
            echo "------------------------------------------------"
            echo "WARNING SUMMARY:"
            # Cách 2: In dòng 'Warnings (' và 5 dòng tiếp theo (-A 5) để thấy nội dung
            grep -A 5 "Warnings (" /tmp/lynis-report.log
            echo ""

            echo "================================================"
            echo "TOP 10 SUGGESTIONS"
            echo "================================================"
            # Lấy dòng Suggestion và cắt gọn để dễ đọc
            grep "Suggestion:" /tmp/lynis-report.log | head -n 10
            
            rm /tmp/lynis-report.log