name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  # Tên Image theo format: owner/repo (viết thường)
  IMAGE_NAME: yoirk/cicdforweb

jobs:
  # 1. QUÉT BẢO MẬT MÃ NGUỒN (SAST)
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Quét lỗ hổng trong source code và thư viện
      - name: Run Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml # Nếu có
          severity: 'CRITICAL,HIGH'

      # Tạo SBOM cho file system
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom-fs.cyclonedx.json
      
      # Lưu SBOM làm artifact
      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-fs
          path: sbom-fs.cyclonedx.json

  # 2. BUILD IMAGE & ĐẨY LÊN REGISTRY
  build-and-push:
    needs: security-scan # Chỉ chạy nếu scan code OK
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Cần quyền để push lên GHCR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build và Push Image
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Tag theo latest và commit hash để dễ rollback
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # 3. DEPLOY LÊN VPS 
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Copy file docker-compose.yml mới nhất lên VPS
      - name: Copy docker-compose via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "/root/my-app/"

      # SSH vào VPS để pull image và restart container
      - name: Execute remote deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /root/my-app
            
            # 1. Pull image mới nhất
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # 2. Cấp quyền đọc SSL (Đã fix lỗi thiếu thư mục archive)
            echo "Setting certificate permissions..."
            
            # Mở quyền truy cập các thư mục cha (quan trọng để user 101 đi xuyên qua được)
            chmod 755 /etc/letsencrypt
            chmod 755 /etc/letsencrypt/live
            chmod 755 /etc/letsencrypt/archive
            
            # Mở quyền thư mục domain cụ thể
            chmod 755 /etc/letsencrypt/live/wanderingtomes.site
            chmod 755 /etc/letsencrypt/archive/wanderingtomes.site
            
            # Cấp quyền đọc file (Khi chmod vào file trong /live, nó tự apply vào file gốc trong /archive)
            chmod 644 /etc/letsencrypt/live/wanderingtomes.site/fullchain.pem
            chmod 644 /etc/letsencrypt/live/wanderingtomes.site/privkey.pem
            
            # 3. Restart container
            docker compose down
            docker compose up -d
            
            # 4. Dọn dẹp
            docker image prune -f

  # 4. QUÉT BẢO MẬT ĐỘNG (DAST)
  dast-scan:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.11.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          docker_name: 'zaproxy/zap-stable'
          target: 'https://wanderingtomes.site' # Domain của website
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -u 0'
          allow_issue_writing: false # Tắt tạo issue nếu không muốn spam

  # 5. THÔNG BÁO (DISCORD)
  notify:
    if: always()
    needs: [security-scan, build-and-push, deploy, dast-scan]
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: nobrayner/discord-webhook@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          discord-webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "CI/CD Pipeline Status"
          description: "Build & Deploy cho commit ${{ github.sha }} đã hoàn tất."
          color-success: '#2eb886'
          color-failure: '#ff0000'