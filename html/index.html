<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoes in the Void</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23a78bfa%22/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        void: '#0f0c29',
                        void_mid: '#302b63',
                        void_light: '#24243e',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Hiệu ứng nền chuyển động */
        body {
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Ẩn thanh cuộn nhưng vẫn cuộn được */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Glassmorphism Class */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.2);
        }

        /* Input Reset */
        .zen-input {
            background: transparent; border: none; outline: none;
            width: 100%; color: #fff;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <header class="fixed top-0 w-full z-40 px-8 py-6 flex justify-between items-center pointer-events-none">
        <div class="pointer-events-auto cursor-pointer" onclick="location.reload()">
            <h1 class="font-serif text-2xl tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-purple-200 to-pink-200">
                ECHOES
            </h1>
        </div>
        <div class="pointer-events-auto flex gap-6 text-purple-200/70">
            <button onclick="openSearch()" class="hover:text-white transition transform hover:scale-110"><i class="fa-solid fa-magnifying-glass text-xl"></i></button>
            <button onclick="checkAuth()" class="hover:text-white transition transform hover:scale-110"><i class="fa-solid fa-user-astronaut text-xl"></i></button>
        </div>
    </header>

    <main class="flex-grow relative pt-24 pb-32 px-4 md:px-20 overflow-y-auto" id="streamContainer">
        <div class="columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6 mx-auto max-w-7xl" id="cardGrid">
            </div>
        
        <div id="loading" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="animate-pulse text-purple-300 font-serif tracking-widest">Listening to the void...</div>
        </div>
    </main>

    <div class="fixed bottom-10 left-0 w-full z-40 flex justify-center gap-8 pointer-events-none">
        <button onclick="wander()" class="pointer-events-auto glass w-14 h-14 rounded-full flex items-center justify-center text-purple-200 hover:text-white transition-all transform hover:rotate-180 duration-700" title="Wander (Đi dạo)">
            <i class="fa-solid fa-compass text-2xl"></i>
        </button>

        <button onclick="openWrite()" class="pointer-events-auto bg-purple-500/20 hover:bg-purple-500/40 backdrop-blur-md border border-purple-500/30 w-16 h-16 rounded-full flex items-center justify-center text-white shadow-[0_0_30px_rgba(168,85,247,0.4)] transition-all transform hover:scale-110 hover:-translate-y-2" title="Gửi suy nghĩ">
            <i class="fa-solid fa-pen-nib text-2xl"></i>
        </button>
    </div>

    <div id="readModal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-xl hidden opacity-0 transition-opacity duration-500 flex items-center justify-center p-4" onclick="closeRead()">
        <div class="max-w-2xl w-full" onclick="event.stopPropagation()">
            <div class="text-center mb-8">
                <p class="text-purple-300 text-sm tracking-[0.3em] uppercase mb-2" id="readAuthor">Unknown</p>
                <h2 class="font-serif text-3xl md:text-5xl text-white leading-tight" id="readTitle">Book Title</h2>
                <div class="h-1 w-20 bg-gradient-to-r from-transparent via-purple-500 to-transparent mx-auto mt-6"></div>
            </div>
            <div class="prose prose-invert prose-lg mx-auto text-gray-300 font-serif leading-loose text-justify max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                <p id="readContent">Content goes here...</p>
            </div>
            <div class="mt-12 text-center">
                <button onclick="closeRead()" class="text-gray-500 hover:text-white transition text-sm tracking-widest uppercase border-b border-transparent hover:border-white pb-1">Close Memory</button>
            </div>
        </div>
    </div>

    <div id="writeModal" class="fixed inset-0 z-50 bg-[#0f0c29] hidden flex flex-col items-center justify-center transition-all duration-500">
        <button onclick="closeWrite()" class="absolute top-8 right-8 text-gray-500 hover:text-white text-2xl"><i class="fa-solid fa-xmark"></i></button>
        
        <div class="w-full max-w-3xl px-8 animate-float">
            <div class="flex justify-center gap-4 mb-8" id="moodSelector">
                </div>
            <input type="hidden" id="inputMood" value="purple">

            <input type="text" id="inputTitle" placeholder="Tên cuốn sách..." class="zen-input font-serif text-3xl md:text-5xl text-center mb-8 placeholder-gray-700">
            <textarea id="inputContent" rows="5" placeholder="Viết những gì bạn cảm thấy..." class="zen-input font-sans text-xl md:text-2xl text-center text-gray-400 placeholder-gray-800 resize-none"></textarea>
            
            <div class="text-center mt-12">
                <button onclick="submitThought()" class="px-8 py-3 rounded-full border border-purple-500/30 text-purple-300 hover:bg-purple-500/20 transition tracking-widest uppercase text-sm">
                    Gửi vào hư không
                </button>
            </div>
            <p id="writeMsg" class="text-center text-red-400 mt-4 text-sm"></p>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center">
        <div class="glass p-8 rounded-2xl w-full max-w-sm relative">
            <button onclick="document.getElementById('authModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            
            <div id="loginForm">
                <h3 class="font-serif text-2xl text-white mb-6 text-center">Identity</h3>
                <input type="text" id="lUser" placeholder="Username" class="w-full bg-white/5 border border-white/10 rounded p-3 text-white mb-3 focus:border-purple-500 outline-none transition">
                <input type="password" id="lPass" placeholder="Password" class="w-full bg-white/5 border border-white/10 rounded p-3 text-white mb-6 focus:border-purple-500 outline-none transition">
                <button onclick="doLogin()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded transition font-bold tracking-wider">ENTER</button>
                <p class="text-center text-gray-500 text-xs mt-4 cursor-pointer hover:text-purple-300" onclick="switchAuth('register')">Create new identity</p>
                <p id="lMsg" class="text-red-400 text-xs text-center mt-2"></p>
            </div>

            <div id="registerForm" class="hidden">
                <h3 class="font-serif text-2xl text-white mb-6 text-center">New Soul</h3>
                <input type="text" id="rUser" placeholder="Choose a name" class="w-full bg-white/5 border border-white/10 rounded p-3 text-white mb-3 focus:border-purple-500 outline-none transition">
                <input type="password" id="rPass" placeholder="Secret key" class="w-full bg-white/5 border border-white/10 rounded p-3 text-white mb-6 focus:border-purple-500 outline-none transition">
                <button onclick="doRegister()" class="w-full border border-purple-500 text-purple-300 hover:bg-purple-500 hover:text-white py-3 rounded transition font-bold tracking-wider">BEGIN</button>
                <p class="text-center text-gray-500 text-xs mt-4 cursor-pointer hover:text-purple-300" onclick="switchAuth('login')">Return to login</p>
                <p id="rMsg" class="text-red-400 text-xs text-center mt-2"></p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const MOOD_COLORS = {
            'purple': { bg: 'border-purple-500/30 shadow-purple-900/20', text: 'text-purple-200' }, // Bí ẩn
            'blue': { bg: 'border-blue-500/30 shadow-blue-900/20', text: 'text-blue-200' },     // Buồn/Sâu lắng
            'green': { bg: 'border-emerald-500/30 shadow-emerald-900/20', text: 'text-emerald-200' }, // Tươi mới
            'red': { bg: 'border-rose-500/30 shadow-rose-900/20', text: 'text-rose-200' },       // Mạnh mẽ/Đam mê
            'yellow': { bg: 'border-amber-500/30 shadow-amber-900/20', text: 'text-amber-200' }   // Ấm áp/Hoài niệm
        };

        // --- INIT ---
        window.onload = () => {
            loadThoughts();
            renderMoodSelector();
        };

        // --- 1. CORE: LOAD & RENDER CARDS ---
        async function loadThoughts() {
            const grid = document.getElementById('cardGrid');
            const loader = document.getElementById('loading');
            
            // Animation fade out cũ (nếu có)
            if(grid.children.length > 0) {
                anime({ targets: '.thought-card', opacity: 0, translateY: -20, duration: 500, easing: 'easeInOutQuad' });
                await new Promise(r => setTimeout(r, 400));
                grid.innerHTML = '';
            }

            loader.style.display = 'flex';

            try {
                // Fetch Data
                let res = await fetch('/api/thoughts/random');
                let data = await res.json();
                
                loader.style.display = 'none';

                if(data.results.length === 0) {
                    grid.innerHTML = '<div class="text-center w-full col-span-full text-gray-500 mt-20">The void is silent...</div>';
                    return;
                }

                // Render Cards
                data.results.forEach((item, i) => {
                    // Fallback mood nếu DB cũ chưa có
                    let mood = item.mood || Object.keys(MOOD_COLORS)[i % 5]; 
                    if(!MOOD_COLORS[mood]) mood = 'purple';

                    const styles = MOOD_COLORS[mood];
                    
                    const div = document.createElement('div');
                    div.className = `thought-card glass rounded-xl p-6 mb-6 cursor-pointer transform transition duration-500 hover:-translate-y-2 break-inside-avoid opacity-0 border-t ${styles.bg}`;
                    div.onclick = () => openRead(item);

                    // Nội dung thẻ: Quote ngắn + Tên sách
                    const snippet = item.content.length > 100 ? item.content.substring(0, 100) + "..." : item.content;
                    
                    div.innerHTML = `
                        <div class="font-serif text-xl italic mb-4 text-gray-100 opacity-90 leading-relaxed">"${snippet}"</div>
                        <div class="flex items-center justify-between border-t border-white/5 pt-4">
                            <span class="text-xs uppercase tracking-widest font-bold ${styles.text}">${item.book_title}</span>
                            <span class="text-xs text-gray-500"><i class="fa-solid fa-user"></i> ${item.username}</span>
                        </div>
                    `;
                    grid.appendChild(div);
                });

                // Animation Fade In (Stagger)
                anime({
                    targets: '.thought-card',
                    opacity: [0, 1],
                    translateY: [50, 0],
                    delay: anime.stagger(100),
                    easing: 'easeOutExpo'
                });

            } catch (e) {
                console.error(e);
                loader.innerHTML = "Connection lost to the void.";
            }
        }

        function wander() {
            // Hiệu ứng nút xoay đã có trong class CSS hover
            // Gọi load lại data
            loadThoughts();
        }

        // --- 2. READING MODE ---
        function openRead(item) {
            const modal = document.getElementById('readModal');
            document.getElementById('readTitle').innerText = item.book_title;
            document.getElementById('readContent').innerText = item.content;
            document.getElementById('readAuthor').innerText = `Memory by ${item.username}`;
            
            modal.classList.remove('hidden');
            // Fade in modal
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeRead() {
            const modal = document.getElementById('readModal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 500);
        }

        // --- 3. WRITING MODE (ZEN) ---
        function openWrite() {
            if(!localStorage.getItem('token')) {
                document.getElementById('authModal').classList.remove('hidden');
                switchAuth('login');
                return;
            }
            document.getElementById('writeModal').classList.remove('hidden');
        }

        function closeWrite() {
            document.getElementById('writeModal').classList.add('hidden');
        }

        function renderMoodSelector() {
            const container = document.getElementById('moodSelector');
            Object.keys(MOOD_COLORS).forEach(color => {
                let btn = document.createElement('div');
                let bgClass = '';
                // Mapping màu simple cho selector
                if(color==='purple') bgClass='bg-purple-500';
                if(color==='blue') bgClass='bg-blue-500';
                if(color==='green') bgClass='bg-emerald-500';
                if(color==='red') bgClass='bg-rose-500';
                if(color==='yellow') bgClass='bg-amber-500';

                btn.className = `w-6 h-6 rounded-full cursor-pointer transition transform hover:scale-125 ${bgClass} opacity-50 hover:opacity-100`;
                btn.onclick = () => {
                    document.getElementById('inputMood').value = color;
                    // Reset active state visually
                    container.childNodes.forEach(c => c.style.border = 'none');
                    btn.style.border = '2px solid white';
                }
                container.appendChild(btn);
            });
            // Select mặc định cái đầu
            if(container.firstChild) container.firstChild.click();
        }

        async function submitThought() {
            const title = document.getElementById('inputTitle').value;
            const content = document.getElementById('inputContent').value;
            const mood = document.getElementById('inputMood').value;
            
            if(!title || !content) {
                document.getElementById('writeMsg').innerText = "A thought cannot be empty.";
                return;
            }

            try {
                let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({content, book_title:title, mood})
                });
                
                if(res.ok) {
                    closeWrite();
                    // Reset form
                    document.getElementById('inputTitle').value = '';
                    document.getElementById('inputContent').value = '';
                    // Wander đến suy nghĩ mới
                    setTimeout(wander, 500);
                } else {
                    document.getElementById('writeMsg').innerText = "Session expired. Please login again.";
                    localStorage.removeItem('token');
                }
            } catch(e) {
                document.getElementById('writeMsg').innerText = "Error sending thought.";
            }
        }

        // --- 4. AUTH LOGIC (Minimalist) ---
        function checkAuth() {
            if(localStorage.getItem('token')) {
                // Đã login -> Hỏi logout?
                if(confirm(`Log out from ${localStorage.getItem('user')}?`)) {
                    localStorage.clear();
                    location.reload();
                }
            } else {
                document.getElementById('authModal').classList.remove('hidden');
            }
        }
        
        function switchAuth(type) {
            document.getElementById('lMsg').innerText = ''; 
            document.getElementById('rMsg').innerText = '';
            if(type === 'register') {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            } else {
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            }
        }

        // Tận dụng API cũ
        async function doLogin() {
            let u = document.getElementById('lUser').value, p = document.getElementById('lPass').value;
            try {
                let res = await fetch('/api/login', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                if(res.ok) { 
                    let d = await res.json(); 
                    localStorage.setItem('token', d.token); 
                    localStorage.setItem('user', u); 
                    document.getElementById('authModal').classList.add('hidden');
                    openWrite(); // Login xong mở luôn trang viết
                } else document.getElementById('lMsg').innerText = 'Wrong credentials.';
            } catch(e) {}
        }

        async function doRegister() {
            let u = document.getElementById('rUser').value, p = document.getElementById('rPass').value;
            try {
                let res = await fetch('/api/register', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                if(res.ok) { switchAuth('login'); document.getElementById('lMsg').innerText = 'Created. Please login.'; document.getElementById('lMsg').className = 'text-green-400 text-xs text-center mt-2'; } 
                else document.getElementById('rMsg').innerText = 'Username taken.';
            } catch(e) {}
        }
        
        // Search (Giữ lại logic cũ nhưng đổi UI) - Tạm thời chưa implement UI Search mới, dùng Wander là chính.
        function openSearch() {
             let q = prompt("What are you looking for?"); // Dùng prompt đơn giản cho concept Void
             if(q) {
                 // Gọi API Search cũ
                 // ... Logic tương tự loadThoughts nhưng fetch URL search
                 // Để đơn giản cho bài hướng dẫn này, ta tập trung vào Wander.
                 alert("The void is vast. Just wander.");
             }
        }

    </script>
</body>
</html>