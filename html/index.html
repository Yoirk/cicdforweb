<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Wandering Tomes</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 0 auto; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
        input, button { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Wandering Tomes üìö</h1>
    
    <div class="box">
        <h3>üîç T√¨m √Ω t∆∞·ªüng s√°ch</h3>
        <input type="text" id="searchInput" placeholder="Nh·∫≠p t√™n s√°ch...">
        <button onclick="searchThoughts()">T√¨m ki·∫øm</button>
    </div>

    <div id="results" class="box">
        <i>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</i>
    </div>

    <div class="box">
        <div id="loginForm">
            <h3>üîë ƒêƒÉng nh·∫≠p ƒë·ªÉ vi·∫øt</h3>
            <input type="text" id="uUser" placeholder="Username">
            <input type="password" id="uPass" placeholder="Password">
            <button onclick="doLogin()">Login / Register</button>
        </div>

        <div id="postForm" class="hidden">
            <h3>‚úçÔ∏è Chia s·∫ª suy nghƒ©</h3>
            <input type="text" id="bookTitle" placeholder="T√™n cu·ªën s√°ch">
            <textarea id="thoughtContent" rows="3" style="width:100%" placeholder="Suy nghƒ© c·ªßa b·∫°n..."></textarea>
            <button onclick="postThought()">G·ª≠i b√†i</button>
            <button onclick="logout()" style="background:#eee">Logout</button>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        if (token) document.getElementById('loginForm').classList.add('hidden'), document.getElementById('postForm').classList.remove('hidden');

        async function searchThoughts() {
            let q = document.getElementById('searchInput').value;
            let res = await fetch(`/api/thoughts/search?q=${q}`);
            let data = await res.json();
            let html = data.results.map(i => `<p><b>${i.username}</b> vi·∫øt v·ªÅ <b>${i.book_title}</b>:<br>${i.content}</p><hr>`).join('');
            document.getElementById('results').innerHTML = html || 'Kh√¥ng t√¨m th·∫•y.';
        }

        async function doLogin() {
            let u = document.getElementById('uUser').value;
            let p = document.getElementById('uPass').value;
            
            // Th·ª≠ ƒëƒÉng k√Ω tr∆∞·ªõc
            await fetch('/api/register', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({username: u, password: p})
            });

            // Sau ƒë√≥ ƒëƒÉng nh·∫≠p
            let res = await fetch('/api/login', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({username: u, password: p})
            });

            if (res.ok) {
                let data = await res.json();
                localStorage.setItem('token', data.token);
                location.reload();
            } else {
                alert('L·ªói ƒëƒÉng nh·∫≠p');
            }
        }

        async function postThought() {
            let title = document.getElementById('bookTitle').value;
            let content = document.getElementById('thoughtContent').value;
            let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({content: content, book_title: title})
            });
            if (res.ok) { alert('ƒê√£ g·ª≠i!'); searchThoughts(); }
            else alert('L·ªói g·ª≠i b√†i');
        }
        
        function logout() { localStorage.removeItem('token'); location.reload(); }
        
        // Load random ban ƒë·∫ßu
        searchThoughts(); 
    </script>
</body>
</html>