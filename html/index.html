<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wandering Tomes</title>
    <style>
        /* Reset & Base */
        body { font-family: monospace; margin: 0; padding: 0; background: #f4f4f4; }
        
        /* Header */
        header {
            background: #fff; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 100;
        }
        h1 { margin: 0; font-size: 1.5rem; cursor: pointer; }
        .user-btn { 
            font-size: 1.5rem; cursor: pointer; background: none; border: none; 
        }

        /* Main Feed */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { 
            background: #fff; border: 1px solid #333; padding: 20px; 
            margin-bottom: 20px; box-shadow: 4px 4px 0 #333; 
        }
        .book-title { font-weight: bold; font-size: 1.1em; color: #d35400; }
        .author { font-size: 0.8em; color: #666; margin-top: 10px; display: block; }
        .empty-msg { text-align: center; color: #777; margin-top: 50px; }

        /* Modal (Popup) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; 
            justify-content: center; align-items: center; z-index: 200;
        }
        .modal-content {
            background: #fff; padding: 30px; width: 90%; max-width: 400px;
            border: 2px solid #333; box-shadow: 8px 8px 0 #333; position: relative;
        }
        .close-btn { 
            position: absolute; top: 5px; right: 10px; 
            font-size: 1.5rem; cursor: pointer; background: none; border: none;
        }
        
        /* Form Elements */
        input, textarea, button.action-btn { 
            width: 100%; padding: 10px; margin: 10px 0; 
            box-sizing: border-box; border: 1px solid #ccc; 
        }
        button.action-btn { 
            background: #333; color: #fff; cursor: pointer; border: none; font-weight: bold;
        }
        button.action-btn:hover { background: #555; }
        .link-btn { color: blue; text-decoration: underline; cursor: pointer; border: none; background: none;}
        .hidden { display: none; }
        .error { color: red; font-size: 0.9em; }
    </style>
</head>
<body>

    <header>
        <h1 onclick="loadRandomThoughts()">üìö Wandering Tomes</h1>
        <button class="user-btn" onclick="openModal()" id="userIcon">üë§</button>
    </header>

    <div class="container" id="feed">
        <div class="empty-msg">ƒêang t·∫£i nh·ªØng d√≤ng suy nghƒ©...</div>
    </div>

    <div class="modal-overlay" id="authModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            
            <div id="loginForm">
                <h3>üîë ƒêƒÉng nh·∫≠p</h3>
                <input type="text" id="lUser" placeholder="Username">
                <input type="password" id="lPass" placeholder="Password">
                <button class="action-btn" onclick="doLogin()">V√†o ngay</button>
                <p>Ch∆∞a c√≥ t√†i kho·∫£n? <button class="link-btn" onclick="switchForm('register')">ƒêƒÉng k√Ω</button></p>
                <p id="lMsg" class="error"></p>
            </div>

            <div id="registerForm" class="hidden">
                <h3>üìù T·∫°o t√†i kho·∫£n</h3>
                <input type="text" id="rUser" placeholder="Username m·ªõi">
                <input type="password" id="rPass" placeholder="Password m·ªõi">
                <button class="action-btn" onclick="doRegister()">ƒêƒÉng k√Ω</button>
                <p>ƒê√£ c√≥ t√†i kho·∫£n? <button class="link-btn" onclick="switchForm('login')">ƒêƒÉng nh·∫≠p</button></p>
                <p id="rMsg" class="error"></p>
            </div>

            <div id="postForm" class="hidden">
                <h3>‚úçÔ∏è Chia s·∫ª suy nghƒ©</h3>
                <p>Xin ch√†o, <b id="welcomeUser"></b>!</p>
                <input type="text" id="bookTitle" placeholder="T√™n cu·ªën s√°ch t√¢m ƒë·∫Øc">
                <textarea id="thoughtContent" rows="5" placeholder="B·∫°n nghƒ© g√¨ v·ªÅ n√≥?"></textarea>
                <button class="action-btn" onclick="postThought()">ƒêƒÉng b√†i</button>
                <button class="action-btn" style="background:#ccc; color:#000" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const token = localStorage.getItem('token');
        const currentUser = localStorage.getItem('user');
        
        // --- Init ---
        loadRandomThoughts();
        updateUserIcon();

        // --- Logic Hi·ªÉn th·ªã ---
        async function loadRandomThoughts() {
            try {
                let res = await fetch('/api/thoughts/random');
                let data = await res.json();
                renderFeed(data.results);
            } catch (e) { console.error(e); }
        }

        function renderFeed(items) {
            const feed = document.getElementById('feed');
            if (!items || items.length === 0) {
                feed.innerHTML = '<div class="empty-msg">Ch∆∞a c√≥ b√†i vi·∫øt n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>';
                return;
            }
            feed.innerHTML = items.map(i => `
                <div class="card">
                    <div class="book-title">üìñ ${escapeHtml(i.book_title)}</div>
                    <p>${escapeHtml(i.content)}</p>
                    <small class="author">‚Äï ${escapeHtml(i.username)}</small>
                </div>
            `).join('');
        }

        // --- Modal & Auth Logic ---
        function openModal() {
            document.getElementById('authModal').style.display = 'flex';
            // N·∫øu ƒë√£ login -> hi·ªán form post, ch∆∞a -> hi·ªán login
            if (localStorage.getItem('token')) {
                switchForm('post');
                document.getElementById('welcomeUser').innerText = localStorage.getItem('user');
            } else {
                switchForm('login');
            }
        }

        function closeModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        // ƒê√≥ng modal khi click ra ngo√†i
        document.getElementById('authModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function switchForm(type) {
            ['loginForm', 'registerForm', 'postForm'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(type + 'Form').classList.remove('hidden');
            // Reset msg
            document.getElementById('lMsg').innerText = '';
            document.getElementById('rMsg').innerText = '';
        }

        function updateUserIcon() {
            const btn = document.getElementById('userIcon');
            if (localStorage.getItem('token')) {
                btn.innerText = '‚úçÔ∏è'; // ƒê·ªïi icon th√†nh c√¢y b√∫t khi ƒë√£ login
                btn.title = "Vi·∫øt b√†i / T√†i kho·∫£n";
            } else {
                btn.innerText = 'üë§'; // Icon ng∆∞·ªùi khi ch∆∞a login
            }
        }

        // --- API Calls (Gi·ªØ nguy√™n logic c≈©, ch·ªâ map l·∫°i UI) ---
        async function doLogin() {
            let u = document.getElementById('lUser').value;
            let p = document.getElementById('lPass').value;
            try {
                let res = await fetch('/api/login', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    let data = await res.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', u);
                    updateUserIcon();
                    switchForm('post'); // Chuy·ªÉn ngay sang m√†n h√¨nh vi·∫øt b√†i
                    document.getElementById('welcomeUser').innerText = u;
                } else {
                    document.getElementById('lMsg').innerText = 'Sai th√¥ng tin!';
                }
            } catch (e) { document.getElementById('lMsg').innerText = 'L·ªói m·∫°ng'; }
        }

        async function doRegister() {
            let u = document.getElementById('rUser').value;
            let p = document.getElementById('rPass').value;
            try {
                let res = await fetch('/api/register', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    alert('ƒêƒÉng k√Ω xong! H√£y ƒëƒÉng nh·∫≠p.');
                    switchForm('login');
                } else {
                    document.getElementById('rMsg').innerText = 'T√™n ƒë√£ t·ªìn t·∫°i!';
                }
            } catch (e) { document.getElementById('rMsg').innerText = 'L·ªói m·∫°ng'; }
        }

        async function postThought() {
            let title = document.getElementById('bookTitle').value;
            let content = document.getElementById('thoughtContent').value;
            let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({content: content, book_title: title})
            });
            if (res.ok) { 
                alert('ƒê√£ ƒëƒÉng!'); 
                closeModal(); 
                document.getElementById('bookTitle').value = ''; // Clear form
                document.getElementById('thoughtContent').value = '';
                loadRandomThoughts(); // Reload feed
            }
            else alert('L·ªói (Token h·∫øt h·∫°n?)');
        }

        function logout() {
            localStorage.clear();
            updateUserIcon();
            closeModal();
            alert('ƒê√£ ƒëƒÉng xu·∫•t');
        }

        // Helper ch·ªëng XSS khi render HTML
        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>