<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wandering Tomes</title>
    <style>
        /* --- Base Styles --- */
        body { font-family: monospace; margin: 0; padding: 0; background: #f4f4f4; overflow-x: hidden; }
        
        header {
            background: #fff; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 100;
        }
        h1 { margin: 0; font-size: 1.5rem; cursor: pointer; }
        
        /* User Icon: Lu√¥n l√† h√¨nh ng∆∞·ªùi, ch·ªâ d√πng ƒë·ªÉ xem info */
        .user-btn { font-size: 1.5rem; cursor: pointer; background: none; border: none; }

        /* --- FLOATING ACTION BUTTON (N√∫t Bong B√≥ng) --- */
        .fab-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: #333;
            color: #fff;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 150;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, background 0.2s;
        }
        .fab-btn:hover {
            transform: scale(1.1); /* Ph√≥ng to nh·∫π khi r√™ chu·ªôt */
            background-color: #000;
        }

        /* --- STREAM FLOW STYLES --- */
        .stream-container {
            width: 100%;
            padding: 50px 0;
            overflow: hidden;
            position: relative;
        }
        .stream-track {
            display: flex;
            gap: 30px;
            width: max-content;
            animation: flow 40s linear infinite;
        }
        .stream-track:hover { animation-play-state: paused; }
        @keyframes flow {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        .card { 
            background: #fff; border: 1px solid #333; padding: 20px; 
            width: 300px; flex-shrink: 0; box-shadow: 6px 6px 0 #333; 
            white-space: normal; display: flex; flex-direction: column; justify-content: space-between;
        }
        .book-title { font-weight: bold; font-size: 1.1em; color: #d35400; margin-bottom: 10px; }
        .content-text { flex-grow: 1; font-size: 0.95em; line-height: 1.5; }
        .author { font-size: 0.8em; color: #666; margin-top: 15px; text-align: right; font-style: italic; }
        .empty-msg { text-align: center; color: #777; width: 100vw; }

        /* --- Modal & Form Styles --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; 
            justify-content: center; align-items: center; z-index: 200;
        }
        .modal-content {
            background: #fff; padding: 30px; width: 90%; max-width: 400px;
            border: 2px solid #333; box-shadow: 8px 8px 0 #333; position: relative;
        }
        .close-btn { 
            position: absolute; top: 5px; right: 10px; 
            font-size: 1.5rem; cursor: pointer; background: none; border: none;
        }
        
        input, textarea, button.action-btn { 
            width: 100%; padding: 10px; margin: 10px 0; 
            box-sizing: border-box; border: 1px solid #ccc; 
        }
        button.action-btn { background: #333; color: #fff; cursor: pointer; border: none; font-weight: bold; }
        button.action-btn:hover { background: #555; }
        .link-btn { color: blue; text-decoration: underline; cursor: pointer; border: none; background: none;}
        
        .hidden { display: none; }
        .error { color: red; font-size: 0.9em; margin-top: 5px; }
        .success { color: green; font-size: 0.9em; margin-top: 5px; font-weight: bold; }
        
        /* Style ri√™ng cho trang th√¥ng tin User */
        .profile-info { text-align: center; margin-bottom: 20px; }
        .profile-avatar { font-size: 3rem; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>

    <header>
        <h1 onclick="loadRandomThoughts()">üìö Wandering Tomes</h1>
        <button class="user-btn" onclick="handleUserIconClick()">üë§</button>
    </header>

    <button class="fab-btn" onclick="handleFabClick()" title="Vi·∫øt b√†i m·ªõi">‚úé</button>

    <div class="stream-container" id="feedContainer">
        <div class="stream-track" id="feedTrack">
            <div class="empty-msg">ƒêang kh∆°i d√≤ng suy nghƒ©...</div>
        </div>
    </div>

    <div class="modal-overlay" id="authModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            
            <div id="loginForm">
                <h3>üîë ƒêƒÉng nh·∫≠p</h3>
                <input type="text" id="lUser" placeholder="Username">
                <input type="password" id="lPass" placeholder="Password">
                <button class="action-btn" onclick="doLogin()">V√†o ngay</button>
                <p>Ch∆∞a c√≥ t√†i kho·∫£n? <button class="link-btn" onclick="switchForm('register')">ƒêƒÉng k√Ω</button></p>
                <p id="lMsg"></p> 
            </div>

            <div id="registerForm" class="hidden">
                <h3>üìù T·∫°o t√†i kho·∫£n</h3>
                <input type="text" id="rUser" placeholder="Username m·ªõi">
                <input type="password" id="rPass" placeholder="Password m·ªõi">
                <button class="action-btn" onclick="doRegister()">ƒêƒÉng k√Ω</button>
                <p>ƒê√£ c√≥ t√†i kho·∫£n? <button class="link-btn" onclick="switchForm('login')">ƒêƒÉng nh·∫≠p</button></p>
                <p id="rMsg" class="error"></p>
            </div>

            <div id="postForm" class="hidden">
                <h3>‚úçÔ∏è Chia s·∫ª suy nghƒ©</h3>
                <input type="text" id="bookTitle" placeholder="T√™n cu·ªën s√°ch t√¢m ƒë·∫Øc">
                <textarea id="thoughtContent" rows="5" placeholder="B·∫°n nghƒ© g√¨ v·ªÅ n√≥?"></textarea>
                <button class="action-btn" onclick="postThought()">Th·∫£ tr√¥i d√≤ng suy nghƒ©</button>
                <p id="pMsg" class="error"></p>
            </div>

            <div id="profileForm" class="hidden">
                <h3>H·ªì s∆° ng∆∞·ªùi d√πng</h3>
                <div class="profile-info">
                    <span class="profile-avatar">üë§</span>
                    <p>Xin ch√†o, <b id="profileName">User</b>!</p>
                </div>
                <button class="action-btn" style="background:#ccc; color:#000" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
    </div>

    <script>
        // Init
        loadRandomThoughts();

        // --- Logic X·ª≠ l√Ω s·ª± ki·ªán Click ---
        
        // 1. Khi b·∫•m v√†o User Icon tr√™n Header
        function handleUserIconClick() {
            clearInputs();
            document.getElementById('authModal').style.display = 'flex';
            
            if (localStorage.getItem('token')) {
                // ƒê√£ login -> Hi·ªán Profile
                switchForm('profile', false);
                document.getElementById('profileName').innerText = localStorage.getItem('user');
            } else {
                // Ch∆∞a login -> Hi·ªán Login
                switchForm('login', false);
            }
        }

        // 2. Khi b·∫•m v√†o N√∫t FAB (Vi·∫øt b√†i)
        function handleFabClick() {
            clearInputs();
            document.getElementById('authModal').style.display = 'flex';

            if (localStorage.getItem('token')) {
                // ƒê√£ login -> Hi·ªán Form Vi·∫øt b√†i
                switchForm('post', false);
            } else {
                // Ch∆∞a login -> Hi·ªán Login (k√®m th√¥ng b√°o nh·∫Øc nh·ªü)
                switchForm('login', false);
                // Nh·∫Øc user c·∫ßn login ƒë·ªÉ vi·∫øt
                let msg = document.getElementById('lMsg');
                msg.innerText = "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ vi·∫øt b√†i nh√©!";
                msg.className = 'error'; 
            }
        }

        // --- C√°c Logic c≈© (Stream, API) gi·ªØ nguy√™n ---
        
        function clearInputs() {
            document.querySelectorAll('input, textarea').forEach(input => input.value = '');
            ['lMsg', 'rMsg', 'pMsg'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.innerText = ''; el.className = ''; }
            });
        }

        function closeModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        document.getElementById('authModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function switchForm(type, shouldClear = true) {
            if(shouldClear) clearInputs();
            // ·∫®n t·∫•t c·∫£ form
            ['loginForm', 'registerForm', 'postForm', 'profileForm'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // Hi·ªán form c·∫ßn thi·∫øt
            document.getElementById(type + 'Form').classList.remove('hidden');
        }

        // --- API Calls ---
        async function loadRandomThoughts() {
            try {
                let res = await fetch('/api/thoughts/random');
                let data = await res.json();
                renderFeed(data.results);
            } catch (e) { console.error(e); }
        }

        function renderFeed(items) {
            const track = document.getElementById('feedTrack');
            if (!items || items.length === 0) {
                track.innerHTML = '<div class="empty-msg">D√≤ng s√¥ng ƒëang tƒ©nh l·∫∑ng...</div>';
                return;
            }
            const cardsHtml = items.map(i => `
                <div class="card">
                    <div class="book-title">üìñ ${escapeHtml(i.book_title)}</div>
                    <div class="content-text">${escapeHtml(i.content)}</div>
                    <small class="author">‚Äï ${escapeHtml(i.username)}</small>
                </div>
            `).join('');
            track.innerHTML = cardsHtml + cardsHtml; 
        }

        async function doRegister() {
            let u = document.getElementById('rUser').value;
            let p = document.getElementById('rPass').value;
            if(!u || !p) { document.getElementById('rMsg').innerText = 'Thi·∫øu th√¥ng tin r·ªìi'; return; }
            try {
                let res = await fetch('/api/register', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    switchForm('login'); 
                    let msg = document.getElementById('lMsg');
                    msg.innerText = 'ƒêƒÉng k√Ω th√†nh c√¥ng! M·ªùi b·∫°n v√†o.';
                    msg.className = 'success';
                    document.getElementById('lUser').value = u;
                } else {
                    document.getElementById('rMsg').innerText = 'T√™n n√†y ƒë√£ c√≥ ng∆∞·ªùi d√πng.';
                    document.getElementById('rMsg').className = 'error';
                }
            } catch (e) { document.getElementById('rMsg').innerText = 'L·ªói k·∫øt n·ªëi'; }
        }

        async function doLogin() {
            let u = document.getElementById('lUser').value;
            let p = document.getElementById('lPass').value;
            let msg = document.getElementById('lMsg');
            msg.innerText = 'ƒêang ki·ªÉm tra...'; msg.className = '';

            try {
                let res = await fetch('/api/login', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    let data = await res.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', u);
                    
                    // Logic m·ªõi: Login xong th√¨ ƒë√≥ng modal lu√¥n (ho·∫∑c chuy·ªÉn sang Profile n·∫øu mu·ªën)
                    // ·ªû ƒë√¢y m√¨nh ch·ªçn ƒë√≥ng modal ƒë·ªÉ user ti·∫øp t·ª•c xem b√†i
                    closeModal(); 
                    
                    // N·∫øu login t·ª´ n√∫t FAB, c√≥ th·ªÉ mu·ªën m·ªü l·∫°i form Post? 
                    // ƒê·ªÉ ƒë∆°n gi·∫£n v√† "chill", c·ª© ƒë√≥ng modal ƒë√£. User mu·ªën vi·∫øt th√¨ b·∫•m FAB l·∫°i.
                } else {
                    msg.innerText = 'Sai t√™n ho·∫∑c m·∫≠t kh·∫©u r·ªìi!';
                    msg.className = 'error';
                }
            } catch (e) { 
                msg.innerText = 'L·ªói k·∫øt n·ªëi'; msg.className = 'error';
            }
        }

        async function postThought() {
            let title = document.getElementById('bookTitle').value;
            let content = document.getElementById('thoughtContent').value;
            let pMsg = document.getElementById('pMsg');

            if(!title || !content) { pMsg.innerText = "H√£y vi·∫øt g√¨ ƒë√≥ nh√©."; return; }

            try {
                let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({content: content, book_title: title})
                });
                if (res.ok) { 
                    closeModal(); 
                    loadRandomThoughts();
                } else {
                    pMsg.innerText = "L·ªói x√°c th·ª±c (H·∫øt h·∫°n phi√™n?).";
                }
            } catch (e) { pMsg.innerText = "L·ªói k·∫øt n·ªëi."; }
        }

        function logout() {
            localStorage.clear();
            closeModal();
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>