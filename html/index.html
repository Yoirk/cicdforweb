<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wandering Tomes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. SETTING CHUNG & VIBE --- */
        body { 
            font-family: 'Georgia', serif; 
            margin: 0; 
            background-color: #1a0f0a; /* T·ªëi h∆°n n·ªØa */
            background-image: radial-gradient(circle at 50% 40%, #3e2723 0%, #1a0f0a 80%);
            height: 100vh; 
            overflow: hidden; 
            display: flex; flex-direction: column; 
            color: #d7ccc8;
        }
        
        /* --- 2. HEADER & SEARCH --- */
        header { 
            padding: 0 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 70px; z-index: 100;
        }
        .header-btn { 
            font-size: 1.6rem; cursor: pointer; background: none; border: none; 
            color: #8d6e63; transition: all 0.3s;
        }
        .header-btn:hover { color: #d7ccc8; transform: scale(1.1); text-shadow: 0 0 10px #8d6e63; }
        .header-right { display: flex; gap: 20px; }

        /* Search Bar Tr∆∞·ª£t */
        .search-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 80px;
            background: #2c1e18; z-index: 101;
            display: flex; align-items: center; justify-content: center;
            transform: translateY(-100%); transition: transform 0.4s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .search-container.active { transform: translateY(0); }
        .search-input {
            width: 60%; background: transparent; border: none; border-bottom: 2px solid #8d6e63;
            color: #fff; font-size: 1.5rem; padding: 10px; font-family: 'Georgia', serif; outline: none;
        }
        .close-search { position: absolute; right: 30px; font-size: 2rem; color: #8d6e63; cursor: pointer; }

        /* --- 3. K·ªÜ S√ÅCH (Bookshelf) --- */
        .room-container {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            perspective: 1200px;
        }
        .bookshelf-wrapper { filter: drop-shadow(0 30px 40px rgba(0,0,0,0.9)); }
        .bookshelf {
            width: 800px; max-width: 90vw;
            background: #281812; /* G·ªó mun t·ªëi */
            border: 15px solid #3e2723; border-radius: 5px;
            display: grid; grid-template-rows: 1fr 15px 1fr;
            padding: 30px 40px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.9); /* B√≥ng t·ªëi trong h·ªôc */
            position: relative;
        }
        .shelf-divider {
            background: #3e2723; height: 15px; width: 100%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.8); z-index: 2;
        }
        .shelf-row {
            display: flex; align-items: flex-end; justify-content: space-around;
            padding: 0 10px; height: 220px;
            transform-style: preserve-3d;
        }

        /* --- 4. S√ÅCH VINTAGE --- */
        .book-spine {
            width: 48px; height: 190px;
            border-radius: 4px 2px 2px 4px; margin: 0 10px;
            cursor: pointer; position: relative;
            transform-origin: bottom center;
            transition: transform 0.3s cubic-bezier(0.25, 1.5, 0.5, 1);
            box-shadow: -3px 0 5px rgba(0,0,0,0.6), inset 2px 0 5px rgba(255,255,255,0.1);
            
            /* Text */
            writing-mode: vertical-rl; text-orientation: mixed;
            display: flex; align-items: center; justify-content: center;
            padding: 10px 0; color: #e0e0e0;
            font-family: 'Courier New', monospace; font-size: 0.8em; font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .book-spine:hover { transform: translateY(-20px) scale(1.05); z-index: 10; }

        /* B·∫£ng m√†u Vintage (Override b·∫±ng JS) */
        .book-color-1 { background: #561818; } /* ƒê·ªè r∆∞·ª£u */
        .book-color-2 { background: #1a237e; } /* Xanh than */
        .book-color-3 { background: #1b5e20; } /* Xanh r√™u */
        .book-color-4 { background: #4e342e; } /* N√¢u ƒë·∫•t */
        .book-color-5 { background: #263238; } /* X√°m ƒëen */

        /* N√∫t Refresh */
        .refresh-btn {
            position: absolute; right: -70px; top: 50%; transform: translateY(-50%);
            color: #5d4037; font-size: 2rem; cursor: pointer; transition: 0.4s;
            background: none; border: none;
        }
        .refresh-btn:hover { color: #d7ccc8; transform: translateY(-50%) rotate(180deg); }

        /* --- 5. FAB BUTTON (N√∫t vi·∫øt b√†i) --- */
        .fab-btn {
            position: fixed; bottom: 40px; right: 40px;
            width: 60px; height: 60px; background: #d7ccc8; color: #3e2723;
            border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-size: 1.5rem; cursor: pointer; z-index: 150;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .fab-btn:hover { transform: scale(1.1); background: #fff; }

        /* --- 6. KHU V·ª∞C ƒê·ªåC S√ÅCH (Fix l·ªói k·∫πt) --- */
        .overlay-3d {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; justify-content: center; align-items: center;
            perspective: 1500px;
            cursor: zoom-out; /* Con tr·ªè b√°o hi·ªáu b·∫•m ƒë·ªÉ tho√°t */
        }

        .book-3d {
            width: 320px; height: 480px; position: relative;
            transform-style: preserve-3d; transition: transform 0.8s ease;
            cursor: default; /* Reset con tr·ªè trong s√°ch */
        }
        .book-3d.open { transform: translateX(160px); }

        .layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 4px 8px 8px 4px;
        }

        /* B√¨a s√°ch */
        .cover {
            background: #3e2723; color: #fff; z-index: 2;
            transform-origin: left; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
        }
        .book-3d.open .cover { transform: rotateY(-140deg); }

        /* N·ªôi dung */
        .page-content {
            background: #fffdf0; color: #2c1e18; z-index: 1;
            padding: 30px 25px; overflow-y: auto; font-size: 1rem; line-height: 1.6;
            box-shadow: inset 10px 0 30px rgba(0,0,0,0.1);
        }

        /* N√∫t ƒë√≥ng s√°ch TO R√ï */
        .close-reading-icon {
            position: fixed; top: 30px; right: 30px;
            color: #fff; font-size: 3rem; cursor: pointer;
            opacity: 0.6; transition: 0.3s; z-index: 210;
        }
        .close-reading-icon:hover { opacity: 1; transform: scale(1.1); }

        /* --- 7. MODAL FORM (Chung Login/Post) --- */
        .form-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 300; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .form-box {
            background: #2c1e18; border: 1px solid #5d4037; padding: 40px; width: 380px;
            color: #d7ccc8; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            position: relative;
        }
        .form-box h3 { margin-top: 0; color: #fff; border-bottom: 1px solid #5d4037; padding-bottom: 15px; }
        .form-box input, .form-box textarea {
            width: 100%; padding: 12px; margin: 10px 0; background: #1a0f0a; border: 1px solid #4e342e; color: #fff;
            box-sizing: border-box; font-family: inherit;
        }
        .form-box button {
            width: 100%; padding: 12px; background: #5d4037; color: #fff; border: none;
            font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s;
        }
        .form-box button:hover { background: #8d6e63; }
        .hidden { display: none; }
        .error { color: #ef9a9a; font-size: 0.9em; margin-top: 5px; }
        .close-form-btn {
            position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #8d6e63;
        }

    </style>
</head>
<body>

    <header>
        <button class="header-btn" onclick="loadBooks()" title="L√†m m·ªõi"><i class="fa-solid fa-book-open"></i></button>
        <div class="header-right">
            <button class="header-btn" onclick="toggleSearch()" title="T√¨m s√°ch"><i class="fa-solid fa-magnifying-glass"></i></button>
            <button class="header-btn" onclick="handleAuthClick()" title="T√†i kho·∫£n"><i class="fa-solid fa-user"></i></button>
        </div>
    </header>

    <div class="search-container" id="searchBar">
        <input type="text" class="search-input" id="searchInput" placeholder="Nh·∫≠p t√™n s√°ch v√† nh·∫•n Enter..." onkeypress="handleSearch(event)">
        <i class="fa-solid fa-xmark close-search" onclick="toggleSearch()"></i>
    </div>

    <div class="room-container">
        <div class="bookshelf-wrapper">
            <div class="bookshelf" id="bookshelf">
                <div class="shelf-row" id="shelfRow1"></div>
                <div class="shelf-divider"></div>
                <div class="shelf-row" id="shelfRow2"></div>
                
                <button class="refresh-btn" onclick="refreshShelf()" title="ƒê·ªïi s√°ch kh√°c">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </div>
    </div>

    <button class="fab-btn" onclick="handleWriteClick()" title="Vi·∫øt suy nghƒ© m·ªõi">
        <i class="fa-solid fa-pen-nib"></i>
    </button>

    <div class="overlay-3d" id="readOverlay" onclick="closeReadBook(event)">
        <i class="fa-solid fa-xmark close-reading-icon" onclick="forceCloseRead()"></i>
        
        <div class="book-3d" id="book3d" onclick="event.stopPropagation()"> <div class="layer cover" id="bookCover">
                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;" id="coverTitle">Title</div>
                <div style="font-style: italic; opacity: 0.8;" id="coverAuthor">Author</div>
            </div>
            <div class="layer page-content">
                <h3 id="pageTitle" style="color:#5d4037; border-bottom:1px solid #ccc; padding-bottom:10px;">Title</h3>
                <p id="pageText" style="text-align: justify; white-space: pre-wrap;">Content...</p>
                <p style="text-align: right; margin-top:30px; font-style: italic; color:#888;">‚Äï <span id="pageUser">User</span></p>
            </div>
        </div>
    </div>

    <div class="form-overlay" id="formModal">
        <div class="form-box">
            <i class="fa-solid fa-xmark close-form-btn" onclick="closeForm()"></i>
            
            <div id="loginForm">
                <h3><i class="fa-solid fa-key"></i> ƒêƒÉng nh·∫≠p</h3>
                <input type="text" id="lUser" placeholder="T√™n ƒëƒÉng nh·∫≠p">
                <input type="password" id="lPass" placeholder="M·∫≠t kh·∫©u">
                <button onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
                <p style="font-size: 0.9em; margin-top:15px;">
                    Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" style="color:#a1887f" onclick="switchView('register')">ƒêƒÉng k√Ω ngay</a>
                </p>
                <p id="lMsg" class="error"></p>
            </div>

            <div id="registerForm" class="hidden">
                <h3><i class="fa-solid fa-user-plus"></i> ƒêƒÉng k√Ω th·∫ª</h3>
                <input type="text" id="rUser" placeholder="T√™n m·ªõi">
                <input type="password" id="rPass" placeholder="M·∫≠t kh·∫©u">
                <button onclick="doRegister()">T·∫°o t√†i kho·∫£n</button>
                <p style="font-size: 0.9em; margin-top:15px;">
                    <a href="#" style="color:#a1887f" onclick="switchView('login')">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
                </p>
                <p id="rMsg" class="error"></p>
            </div>

            <div id="postForm" class="hidden">
                <h3><i class="fa-solid fa-feather-pointed"></i> Vi·∫øt suy nghƒ©</h3>
                <input type="text" id="bookTitle" placeholder="T√™n cu·ªën s√°ch">
                <textarea id="thoughtContent" rows="5" placeholder="B·∫°n c·∫£m th·∫•y th·∫ø n√†o v·ªÅ n√≥?"></textarea>
                <button onclick="postThought()">L∆∞u v√†o k·ªá</button>
                <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                    <span style="font-size: 0.8em; color: #888;">User: <b id="postUserDisplay"></b></span>
                    <a href="#" style="color:#ef9a9a; font-size: 0.9em;" onclick="logout()">ƒêƒÉng xu·∫•t</a>
                </div>
                <p id="pMsg" class="error"></p>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        loadBooks();

        // --- 1. Logic K·ªá s√°ch (Fix tr√πng l·∫∑p & M√†u s·∫Øc) ---
        async function loadBooks(query = '') {
            const shelf = document.getElementById('bookshelf');
            shelf.style.opacity = '0.5';
            
            try {
                // G·ªçi API (Search ho·∫∑c Random)
                let url = query ? `/api/thoughts/search?q=${query}` : '/api/thoughts/random';
                let res = await fetch(url);
                let data = await res.json();
                
                setTimeout(() => {
                    // FIX: Kh√¥ng nh√¢n b·∫£n s√°ch n·ªØa. C√≥ bao nhi√™u hi·ªán b·∫•y nhi√™u.
                    renderShelf(data.results);
                    shelf.style.opacity = '1';
                }, 300);
            } catch (e) { console.error(e); }
        }

        function renderShelf(books) {
            const row1 = document.getElementById('shelfRow1');
            const row2 = document.getElementById('shelfRow2');
            row1.innerHTML = ''; row2.innerHTML = '';
            
            if(books.length === 0) {
                row1.innerHTML = '<div style="color:#777; width:100%; text-align:center; padding-top:50px;">K·ªá tr·ªëng...</div>';
                return;
            }

            // Gi·ªõi h·∫°n 10 cu·ªën t·ªëi ƒëa
            books.slice(0, 10).forEach((book, index) => {
                const el = document.createElement('div');
                
                // Add class m√†u ng·∫´u nhi√™n (vintage colors)
                const colorClass = `book-color-${(index % 5) + 1}`;
                el.className = `book-spine ${colorClass}`;
                
                // Random chi·ªÅu cao
                const h = Math.floor(Math.random() * 30) + 175;
                el.style.height = `${h}px`;
                el.innerText = book.book_title.length > 25 ? book.book_title.substring(0,22)+'...' : book.book_title;
                
                // Click m·ªü s√°ch
                const bookData = {...book, colorIndex: (index % 5) + 1};
                el.onclick = () => openReadBook(bookData);

                if (index < 5) row1.appendChild(el);
                else row2.appendChild(el);
            });
        }

        // --- 2. Logic ƒê·ªçc s√°ch (Tho√°t k·∫πt) ---
        function openReadBook(book) {
            const overlay = document.getElementById('readOverlay');
            const book3d = document.getElementById('book3d');
            const cover = document.getElementById('bookCover');
            
            // Set Data
            document.getElementById('coverTitle').innerText = book.book_title;
            document.getElementById('coverAuthor').innerText = book.username;
            document.getElementById('pageTitle').innerText = book.book_title;
            document.getElementById('pageText').innerText = book.content;
            document.getElementById('pageUser').innerText = book.username;

            // Set m√†u b√¨a tr√πng m√†u g√°y s√°ch (D√πng m·∫£ng m√†u CSS t∆∞∆°ng ·ª©ng)
            const colors = ['#561818', '#1a237e', '#1b5e20', '#4e342e', '#263238'];
            cover.style.background = colors[book.colorIndex - 1];

            overlay.style.display = 'flex';
            setTimeout(() => book3d.classList.add('open'), 50);
        }

        function closeReadBook(e) {
            // Ch·ªâ ƒë√≥ng n·∫øu click v√†o v√πng ƒëen (overlay), kh√¥ng ƒë√≥ng n·∫øu click v√†o s√°ch
            if (e.target.id === 'readOverlay') forceCloseRead();
        }

        function forceCloseRead() {
            const book3d = document.getElementById('book3d');
            const overlay = document.getElementById('readOverlay');
            book3d.classList.remove('open');
            setTimeout(() => overlay.style.display = 'none', 800);
        }

        // --- 3. Logic T√¨m ki·∫øm & Refresh ---
        function toggleSearch() {
            const bar = document.getElementById('searchBar');
            bar.classList.toggle('active');
            if(bar.classList.contains('active')) document.getElementById('searchInput').focus();
        }

        function handleSearch(e) {
            if (e.key === 'Enter') {
                loadBooks(e.target.value);
                toggleSearch();
            }
        }
        
        function refreshShelf() {
            const btn = document.querySelector('.refresh-btn');
            btn.style.transform = 'translateY(-50%) rotate(360deg)';
            setTimeout(() => btn.style.transform = 'translateY(-50%)', 500);
            loadBooks(); // Load random l·∫°i
        }

        // --- 4. Logic Auth & Vi·∫øt b√†i (G·ªôp Flow) ---
        function handleWriteClick() {
            openFormModal();
            // N·∫øu ƒë√£ login -> V√†o th·∫≥ng post
            if (localStorage.getItem('token')) switchView('post');
            else switchView('login');
        }

        function handleAuthClick() {
            openFormModal();
            if (localStorage.getItem('token')) switchView('post');
            else switchView('login');
        }

        function openFormModal() { document.getElementById('formModal').style.display = 'flex'; }
        function closeForm() { document.getElementById('formModal').style.display = 'none'; }
        
        function switchView(viewId) {
            ['loginForm', 'registerForm', 'postForm'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId + 'Form').classList.remove('hidden');
            
            // X√≥a th√¥ng b√°o l·ªói c≈©
            ['lMsg', 'rMsg', 'pMsg'].forEach(id => document.getElementById(id).innerText = '');

            if(viewId === 'post') {
                document.getElementById('postUserDisplay').innerText = localStorage.getItem('user');
            }
        }

        // --- API Calls ---
        async function doLogin() {
            let u = document.getElementById('lUser').value, p = document.getElementById('lPass').value;
            try {
                let res = await fetch('/api/login', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                if(res.ok) { 
                    let d = await res.json(); 
                    localStorage.setItem('token', d.token); 
                    localStorage.setItem('user', u); 
                    switchView('post'); // Login xong -> Chuy·ªÉn ngay sang vi·∫øt b√†i
                } else {
                    document.getElementById('lMsg').innerText = 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!';
                }
            } catch(e) { document.getElementById('lMsg').innerText = 'L·ªói k·∫øt n·ªëi'; }
        }

        async function doRegister() {
            let u = document.getElementById('rUser').value, p = document.getElementById('rPass').value;
            try {
                let res = await fetch('/api/register', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                if(res.ok) { 
                    switchView('login');
                    document.getElementById('lMsg').innerText = 'ƒêƒÉng k√Ω th√†nh c√¥ng! M·ªùi ƒëƒÉng nh·∫≠p.';
                    document.getElementById('lMsg').style.color = '#69f0ae';
                    document.getElementById('lUser').value = u;
                } else {
                    document.getElementById('rMsg').innerText = 'T√™n n√†y ƒë√£ c√≥ ng∆∞·ªùi d√πng.';
                }
            } catch(e) { document.getElementById('rMsg').innerText = 'L·ªói k·∫øt n·ªëi'; }
        }

        async function postThought() {
            let t = document.getElementById('bookTitle').value, c = document.getElementById('thoughtContent').value;
            if(!t || !c) { document.getElementById('pMsg').innerText = 'H√£y nh·∫≠p ƒë·ªß th√¥ng tin nh√©.'; return; }
            
            try {
                let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:c,book_title:t})});
                if(res.ok) { 
                    closeForm(); 
                    loadBooks(); // Reload k·ªá s√°ch ƒë·ªÉ th·∫•y b√†i m·ªõi
                    alert('ƒê√£ th√™m s√°ch l√™n k·ªá!');
                } else {
                    document.getElementById('pMsg').innerText = 'L·ªói x√°c th·ª±c (H·∫øt h·∫°n phi√™n?).';
                }
            } catch(e) { document.getElementById('pMsg').innerText = 'L·ªói k·∫øt n·ªëi'; }
        }

        function logout() {
            localStorage.clear();
            switchView('login');
        }
    </script>
</body>
</html>