<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wandering Tomes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. ATMOSPHERE & BASE --- */
        body { 
            font-family: 'Georgia', serif; /* Font ch·ªØ c√≥ ch√¢n cho gi·ªëng s√°ch gi·∫•y */
            margin: 0; 
            background-color: #2c1e18; /* M√†u t∆∞·ªùng t·ªëi */
            /* Hi·ªáu ·ª©ng ƒë√®n chi·∫øu s√°ng trung t√¢m (Vignette) */
            background-image: radial-gradient(circle at center, #4e342e 0%, #1a100c 100%);
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            color: #d7ccc8;
        }
        
        /* --- 2. HEADER (L√†m trong su·ªët ƒë·ªÉ h√≤a v√†o n·ªÅn) --- */
        header { 
            padding: 0 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            height: 70px; z-index: 100; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header-btn { 
            font-size: 1.5rem; cursor: pointer; background: none; border: none; 
            color: #bcaaa4; transition: all 0.3s; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .header-btn:hover { color: #fff; transform: scale(1.1); text-shadow: 0 0 10px #d7ccc8; }
        .header-right { display: flex; gap: 20px; }

        /* --- 3. BOOKSHELF (K·ªÜ S√ÅCH 3D) --- */
        .room-container {
            flex-grow: 1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            perspective: 1000px; /* T·∫°o chi·ªÅu s√¢u 3D */
            padding-bottom: 50px;
        }

        .bookshelf-shadow {
            /* B√≥ng ƒë·ªï l·ªõn sau k·ªá ƒë·ªÉ t·∫°o c·∫£m gi√°c treo t∆∞·ªùng */
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.8));
        }

        .bookshelf {
            width: 800px; max-width: 90%;
            background: #3e2723;
            border: 12px solid #5d4037; /* Vi·ªÅn g·ªó s√°ng h∆°n ch√∫t */
            border-radius: 8px;
            display: grid;
            grid-template-rows: 1fr 15px 1fr;
            padding: 25px 30px;
            /* Shadow t·∫°o chi·ªÅu s√¢u b√™n trong h·ªôc t·ªß */
            box-shadow: 
                inset 0 0 50px rgba(0,0,0,0.7), /* B√≥ng trong */
                0 0 0 2px #281a14; /* Vi·ªÅn nh·ªè t·ªëi m√†u */
            position: relative;
        }

        /* V√¢n g·ªó (Texture gi·∫£ b·∫±ng CSS gradient) */
        .bookshelf::before {
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 10px);
            pointer-events: none;
        }

        .shelf-divider {
            background: #5d4037;
            box-shadow: 0 5px 10px rgba(0,0,0,0.6);
            height: 15px; width: 100%; border-radius: 2px;
            position: relative; z-index: 2;
        }

        .shelf-row {
            display: flex; align-items: flex-end; justify-content: space-around;
            padding: 0 10px; height: 230px; position: relative;
            transform-style: preserve-3d;
        }

        /* --- 4. THE BOOK (CU·ªêN S√ÅCH TR√äN K·ªÜ) --- */
        .book-spine {
            width: 45px; height: 190px;
            border-radius: 3px; margin: 0 8px;
            cursor: pointer; position: relative;
            transform-origin: bottom center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: -2px 0 5px rgba(0,0,0,0.4); /* B√≥ng g√°y s√°ch */
            
            /* Text d·ªçc */
            writing-mode: vertical-rl; text-orientation: mixed;
            display: flex; align-items: center; justify-content: center;
            padding: 10px 0; color: rgba(255,255,255,0.9);
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 0.85em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            border-left: 1px solid rgba(255,255,255,0.1); /* H·∫Øt s√°ng c·∫°nh tr√°i */
        }

        /* Hi·ªáu ·ª©ng nh·∫•c s√°ch l√™n khi hover */
        .book-spine:hover { transform: translateY(-15px) scale(1.05); z-index: 10; }

        /* M√†u ng·∫´u nhi√™n (t·∫°o b·∫±ng nth-child) */
        .book-spine:nth-child(5n+1) { background: linear-gradient(to right, #8e24aa, #6a1b9a); }
        .book-spine:nth-child(5n+2) { background: linear-gradient(to right, #1e88e5, #1565c0); }
        .book-spine:nth-child(5n+3) { background: linear-gradient(to right, #43a047, #2e7d32); }
        .book-spine:nth-child(5n+4) { background: linear-gradient(to right, #e53935, #c62828); }
        .book-spine:nth-child(5n+5) { background: linear-gradient(to right, #fb8c00, #ef6c00); }

        /* --- 5. DECORATION (TRANG TR√ç) --- */
        .plant-decor {
            position: absolute; top: -55px; right: 20px;
            font-size: 3rem; color: #66bb6a;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
            animation: sway 3s ease-in-out infinite alternate;
        }
        @keyframes sway { from { transform: rotate(-5deg); } to { transform: rotate(5deg); } }

        .refresh-btn {
            position: absolute; right: -70px; top: 50%; transform: translateY(-50%);
            background: #4e342e; color: #bcaaa4; border: 2px solid #5d4037;
            width: 50px; height: 50px; border-radius: 50%; cursor: pointer;
            font-size: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: all 0.4s;
        }
        .refresh-btn:hover { color: #fff; transform: translateY(-50%) rotate(180deg) scale(1.1); background: #5d4037; }

        /* --- 6. REAL 3D BOOK OPENING (HI·ªÜU ·ª®NG L·∫¨T S√ÅCH) --- */
        .overlay-3d {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: none; justify-content: center; align-items: center;
            perspective: 1500px; /* Quan tr·ªçng ƒë·ªÉ th·∫•y 3D */
            backdrop-filter: blur(5px);
        }

        .book-3d {
            width: 300px; height: 450px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease;
            cursor: default;
        }

        /* Khi c√≥ class .open, s√°ch s·∫Ω xoay v√† m·ªü ra */
        .book-3d.open { transform: translateX(150px); } /* D·ªãch sang ph·∫£i ƒë·ªÉ ch·ª´a ch·ªó cho b√¨a m·ªü */

        /* C√°c th√†nh ph·∫ßn cu·ªën s√°ch 3D */
        .layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 5px 10px 10px 5px;
            background-color: #fff;
        }

        /* B√¨a tr∆∞·ªõc (Front Cover) */
        .cover {
            background: #5d4037; /* M√†u b√¨a m·∫∑c ƒë·ªãnh */
            z-index: 2;
            transform-origin: left; /* Xoay t·ª´ g√°y tr√°i */
            transition: transform 1s cubic-bezier(0.645, 0.045, 0.355, 1); /* Hi·ªáu ·ª©ng l·∫≠t m∆∞·ª£t */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; text-align: center; color: #fff;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .book-3d.open .cover { transform: rotateY(-135deg); } /* M·ªü ra 135 ƒë·ªô */

        /* Trang gi·∫•y n·ªôi dung (Inside Page) */
        .page-content {
            z-index: 1;
            background: #fff9e6; /* M√†u gi·∫•y c≈© */
            color: #333;
            padding: 30px;
            box-shadow: inset 10px 0 20px rgba(0,0,0,0.1); /* B√≥ng g√°y s√°ch */
            overflow-y: auto;
            font-family: 'Georgia', serif; line-height: 1.6;
        }

        /* G√°y s√°ch 3D (Spine) */
        .spine-3d {
            position: absolute; top: 0; left: 0; width: 40px; height: 100%;
            background: #3e2723;
            transform: rotateY(90deg) translateX(-20px); /* ƒê·∫∑t vu√¥ng g√≥c */
            transform-origin: left;
        }

        /* Text tr√™n b√¨a */
        .cover-title { font-size: 1.8em; font-weight: bold; margin-bottom: 10px; text-shadow: 1px 1px 2px #000; }
        .cover-author { font-size: 1em; font-style: italic; opacity: 0.8; }

        .close-read-btn {
            position: absolute; top: -50px; right: -50px;
            color: #fff; font-size: 2rem; cursor: pointer; background: none; border: none;
            opacity: 0.7; transition: opacity 0.3s;
        }
        .close-read-btn:hover { opacity: 1; }

        /* --- Utility Forms (Login/Post) - Style t·ªëi gi·∫£n --- */
        .form-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300; display: none;
            justify-content: center; align-items: center;
        }
        .form-box {
            background: #2c1e18; border: 1px solid #5d4037; padding: 40px; width: 350px;
            color: #d7ccc8; border-radius: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }
        .form-box h3 { margin-top: 0; color: #fff; }
        .form-box input, .form-box textarea {
            width: 100%; padding: 12px; margin: 10px 0; background: #3e2723; border: none; color: #fff;
            box-sizing: border-box; font-family: inherit;
        }
        .form-box button {
            width: 100%; padding: 12px; background: #8d6e63; color: #fff; border: none;
            font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.3s;
        }
        .form-box button:hover { background: #a1887f; }
        .hidden { display: none; }
        .error { color: #ff8a80; font-size: 0.9em; margin-top: 5px; }
        .success { color: #69f0ae; font-size: 0.9em; margin-top: 5px; }

    </style>
</head>
<body>

    <header>
        <button class="header-btn" title="Trang ch·ªß"><i class="fa-solid fa-book-open"></i></button>
        <div class="header-right">
            <button class="header-btn" onclick="openAuthModal()"><i class="fa-solid fa-user"></i></button>
        </div>
    </header>

    <div class="room-container">
        <div class="bookshelf-shadow">
            <div class="bookshelf" id="bookshelf">
                <div class="plant-decor"><i class="fa-solid fa-plant-wilt"></i></div>

                <div class="shelf-row" id="shelfRow1"></div>
                <div class="shelf-divider"></div>
                <div class="shelf-row" id="shelfRow2"></div>
                
                <button class="refresh-btn" onclick="refreshShelf()" title="ƒê·ªïi s√°ch kh√°c">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="overlay-3d" id="readOverlay">
        <button class="close-read-btn" onclick="closeReadBook()"><i class="fa-solid fa-xmark"></i></button>
        
        <div class="book-3d" id="book3d">
            <div class="layer cover" id="bookCover">
                <div class="cover-title" id="coverTitle">T√™n S√°ch</div>
                <div class="cover-author" id="coverAuthor">T√°c gi·∫£</div>
                <div style="margin-top:20px; font-size: 2rem;">üìñ</div>
            </div>
            
            <div class="layer page-content">
                <h3 style="color:#5d4037; border-bottom: 2px solid #5d4037; padding-bottom:10px; margin-top:0;" id="pageTitle">Ti√™u ƒë·ªÅ</h3>
                <p id="pageText" style="text-align: justify;">N·ªôi dung...</p>
                <p style="text-align: right; margin-top:30px; font-style: italic; color:#777;">‚Äï <span id="pageUser">User</span></p>
            </div>
        </div>
    </div>

    <div class="form-modal" id="authModal">
        <div class="form-box">
            <div style="text-align: right; margin-bottom: 10px;">
                <i class="fa-solid fa-xmark" style="cursor: pointer;" onclick="closeAuthModal()"></i>
            </div>
            
            <div id="loginForm">
                <h3>ƒêƒÉng nh·∫≠p</h3>
                <input type="text" id="lUser" placeholder="Username">
                <input type="password" id="lPass" placeholder="Password">
                <button onclick="doLogin()">V√†o ƒë·ªçc s√°ch</button>
                <p style="font-size: 0.9em;">Ch∆∞a c√≥ th·∫ª th∆∞ vi·ªán? <a href="#" style="color:#bcaaa4" onclick="switchForm('register')">ƒêƒÉng k√Ω</a></p>
                <p id="lMsg" class="error"></p>
            </div>

            <div id="registerForm" class="hidden">
                <h3>ƒêƒÉng k√Ω th·∫ª</h3>
                <input type="text" id="rUser" placeholder="T√™n m·ªõi">
                <input type="password" id="rPass" placeholder="M·∫≠t kh·∫©u">
                <button onclick="doRegister()">ƒêƒÉng k√Ω</button>
                <p style="font-size: 0.9em;"><a href="#" style="color:#bcaaa4" onclick="switchForm('login')">Quay l·∫°i ƒëƒÉng nh·∫≠p</a></p>
                <p id="rMsg" class="error"></p>
            </div>

            <div id="profileForm" class="hidden">
                <i class="fa-solid fa-user-astronaut" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h3 id="profileName">User</h3>
                <button onclick="switchForm('post')">Vi·∫øt suy nghƒ© m·ªõi</button>
                <button style="background: transparent; border: 1px solid #8d6e63;" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>

            <div id="postForm" class="hidden">
                <h3>Vi·∫øt v√†o nh·∫≠t k√Ω</h3>
                <input type="text" id="bookTitle" placeholder="T√™n s√°ch">
                <textarea id="thoughtContent" rows="5" placeholder="C·∫£m nghƒ© c·ªßa b·∫°n..."></textarea>
                <button onclick="postThought()">L∆∞u l·∫°i</button>
                <p style="font-size: 0.9em;"><a href="#" style="color:#bcaaa4" onclick="switchForm('profile')">Quay l·∫°i</a></p>
                <p id="pMsg" class="error"></p>
            </div>
        </div>
    </div>

    <script>
        // Init
        const token = localStorage.getItem('token');
        loadBooks();

        // --- Logic K·ªá s√°ch ---
        async function loadBooks() {
            try {
                const shelf = document.getElementById('bookshelf');
                shelf.style.opacity = '0.5'; // L√†m m·ªù nh·∫π khi ƒëang load
                
                let res = await fetch('/api/thoughts/random');
                let data = await res.json();
                
                setTimeout(() => {
                    renderShelf(data.results);
                    shelf.style.opacity = '1';
                }, 300);
            } catch (e) { console.error(e); }
        }

        function renderShelf(books) {
            const row1 = document.getElementById('shelfRow1');
            const row2 = document.getElementById('shelfRow2');
            row1.innerHTML = ''; row2.innerHTML = '';

            // N·∫øu √≠t s√°ch qu√° th√¨ nh√¢n b·∫£n l√™n cho ƒë·∫ßy k·ªá
            let displayBooks = books;
            if(displayBooks.length < 8) displayBooks = [...books, ...books]; 
            displayBooks = displayBooks.slice(0, 10); // Max 10 cu·ªën

            displayBooks.forEach((book, index) => {
                const bookEl = document.createElement('div');
                bookEl.className = 'book-spine';
                
                // Random chi·ªÅu cao
                const h = Math.floor(Math.random() * 40) + 180; 
                bookEl.style.height = `${h}px`;
                bookEl.innerText = book.book_title.substring(0, 20);
                
                // Click -> M·ªü s√°ch 3D
                // C·∫ßn clone object ƒë·ªÉ tr√°nh l·ªói tham chi·∫øu
                const bookData = {...book}; 
                bookEl.onclick = () => openReadBook(bookData, index);

                if (index < 5) row1.appendChild(bookEl);
                else row2.appendChild(bookEl);
            });
        }

        // --- Logic ƒê·ªçc s√°ch 3D ---
        function openReadBook(book, index) {
            const overlay = document.getElementById('readOverlay');
            const book3d = document.getElementById('book3d');
            
            // 1. Fill d·ªØ li·ªáu
            document.getElementById('coverTitle').innerText = book.book_title;
            document.getElementById('coverAuthor').innerText = book.username;
            document.getElementById('pageTitle').innerText = book.book_title;
            document.getElementById('pageText').innerText = book.content;
            document.getElementById('pageUser').innerText = book.username;

            // 2. Set m√†u b√¨a (L·∫•y theo m√†u c·ªßa g√°y s√°ch d·ª±a v√†o index ƒë·ªÉ ƒë·ªìng b·ªô)
            // Ta hardcode l·∫°i logic m√†u gi·ªëng CSS nth-child
            const colors = [
                'linear-gradient(to right, #8e24aa, #6a1b9a)',
                'linear-gradient(to right, #1e88e5, #1565c0)',
                'linear-gradient(to right, #43a047, #2e7d32)',
                'linear-gradient(to right, #e53935, #c62828)',
                'linear-gradient(to right, #fb8c00, #ef6c00)'
            ];
            // L·∫•y m√†u t∆∞∆°ng ·ª©ng (index % 5)
            document.getElementById('bookCover').style.background = colors[index % 5];

            // 3. Hi·ªán overlay
            overlay.style.display = 'flex';
            
            // 4. Trigger Animation m·ªü s√°ch (Delay 1 x√≠u ƒë·ªÉ CSS transition b·∫Øt ƒë∆∞·ª£c)
            setTimeout(() => {
                book3d.classList.add('open');
            }, 100);
        }

        function closeReadBook() {
            const book3d = document.getElementById('book3d');
            const overlay = document.getElementById('readOverlay');
            
            // ƒê√≥ng s√°ch tr∆∞·ªõc
            book3d.classList.remove('open');
            
            // ƒê·ª£i ƒë√≥ng xong m·ªõi ·∫©n overlay
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 800); // 800ms kh·ªõp v·ªõi transition CSS
        }

        function refreshShelf() {
            // Xoay nh·∫π n√∫t refresh
            const btn = document.querySelector('.refresh-btn');
            btn.style.transform = 'translateY(-50%) rotate(360deg)';
            setTimeout(() => btn.style.transform = 'translateY(-50%)', 500);
            loadBooks();
        }

        // --- Logic Auth (Gi·ªØ nguy√™n logic c≈©, ch·ªâ ƒë·ªïi UI) ---
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            if (localStorage.getItem('token')) {
                switchForm('profile');
                document.getElementById('profileName').innerText = localStorage.getItem('user');
            } else { switchForm('login'); }
        }
        function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }
        
        function switchForm(type) {
            ['loginForm', 'registerForm', 'profileForm', 'postForm'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(type + 'Form').classList.remove('hidden');
            ['lMsg', 'rMsg', 'pMsg'].forEach(el => el.innerText = '');
        }

        // API Calls (R√∫t g·ªçn)
        async function doLogin() {
            let u = document.getElementById('lUser').value, p = document.getElementById('lPass').value;
            try {
                let res = await fetch('/api/login', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                if(res.ok) { let d=await res.json(); localStorage.setItem('token',d.token); localStorage.setItem('user',u); switchForm('profile'); document.getElementById('profileName').innerText=u;}
                else document.getElementById('lMsg').innerText='Sai th√¥ng tin!';
            } catch(e){}
        }
        async function doRegister() {
            let u = document.getElementById('rUser').value, p = document.getElementById('rPass').value;
            try {
                let res = await fetch('/api/register', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
                if(res.ok) { switchForm('login'); document.getElementById('lMsg').innerText='ƒêƒÉng k√Ω th√†nh c√¥ng!'; document.getElementById('lMsg').className='success'; }
                else document.getElementById('rMsg').innerText='T√™n ƒë√£ t·ªìn t·∫°i!';
            } catch(e){}
        }
        async function postThought() {
            let t = document.getElementById('bookTitle').value, c = document.getElementById('thoughtContent').value;
            try {
                let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:c,book_title:t})});
                if(res.ok) { closeAuthModal(); loadBooks(); alert('ƒê√£ l∆∞u v√†o k·ªá s√°ch!'); }
                else document.getElementById('pMsg').innerText='L·ªói (H·∫øt h·∫°n phi√™n?)';
            } catch(e){}
        }
        function logout(){ localStorage.clear(); closeAuthModal(); }
    </script>
</body>
</html>