<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Wandering Tomes</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 0 auto; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
        input, button { padding: 5px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .hidden { display: none; }
        .link-btn { background: none; border: none; color: blue; text-decoration: underline; cursor: pointer; padding: 0; width: auto; }
        .error { color: red; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>Wandering Tomes üìö</h1>
    
    <div class="box">
        <h3>üîç T√¨m √Ω t∆∞·ªüng s√°ch</h3>
        <input type="text" id="searchInput" placeholder="Nh·∫≠p t√™n s√°ch...">
        <button onclick="searchThoughts()">T√¨m ki·∫øm</button>
    </div>

    <div id="results" class="box">
        <i>K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</i>
    </div>

    <div class="box" id="authBox">
        <div id="loginForm">
            <h3>üîë ƒêƒÉng nh·∫≠p</h3>
            <input type="text" id="lUser" placeholder="Username">
            <input type="password" id="lPass" placeholder="Password">
            <button onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
            <p>Ch∆∞a c√≥ t√†i kho·∫£n? <button class="link-btn" onclick="toggleForm()">ƒêƒÉng k√Ω ngay</button></p>
            <p id="lMsg" class="error"></p>
        </div>

        <div id="registerForm" class="hidden">
            <h3>üìù ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</h3>
            <input type="text" id="rUser" placeholder="Username m·ªõi">
            <input type="password" id="rPass" placeholder="Password m·ªõi">
            <button onclick="doRegister()">ƒêƒÉng k√Ω</button>
            <p>ƒê√£ c√≥ t√†i kho·∫£n? <button class="link-btn" onclick="toggleForm()">Quay l·∫°i ƒëƒÉng nh·∫≠p</button></p>
            <p id="rMsg" class="error"></p>
        </div>

        <div id="postForm" class="hidden">
            <h3>‚úçÔ∏è Chia s·∫ª suy nghƒ©</h3>
            <p>Xin ch√†o, <b id="welcomeUser"></b>!</p>
            <input type="text" id="bookTitle" placeholder="T√™n cu·ªën s√°ch">
            <textarea id="thoughtContent" rows="3" style="width:100%" placeholder="Suy nghƒ© c·ªßa b·∫°n..."></textarea>
            <button onclick="postThought()">G·ª≠i b√†i</button>
            <button onclick="logout()" style="background:#eee">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let currentUser = localStorage.getItem('user');

        // Check tr·∫°ng th√°i login
        if (token) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('postForm').classList.remove('hidden');
            if(currentUser) document.getElementById('welcomeUser').innerText = currentUser;
        }

        function toggleForm() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
            document.getElementById('lMsg').innerText = '';
            document.getElementById('rMsg').innerText = '';
        }

        async function searchThoughts() {
            let q = document.getElementById('searchInput').value;
            try {
                let res = await fetch(`/api/thoughts/search?q=${q}`);
                let data = await res.json();
                let html = data.results.map(i => `<p><b>${i.username}</b> vi·∫øt v·ªÅ <b>${i.book_title}</b>:<br>${i.content}</p><hr>`).join('');
                document.getElementById('results').innerHTML = html || 'Kh√¥ng t√¨m th·∫•y.';
            } catch (e) { console.error(e); }
        }

        async function doLogin() {
            let u = document.getElementById('lUser').value;
            let p = document.getElementById('lPass').value;
            document.getElementById('lMsg').innerText = 'ƒêang x·ª≠ l√Ω...';
            
            try {
                let res = await fetch('/api/login', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });

                if (res.ok) {
                    let data = await res.json();
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', u);
                    location.reload();
                } else {
                    document.getElementById('lMsg').innerText = 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!';
                }
            } catch (e) {
                document.getElementById('lMsg').innerText = 'L·ªói k·∫øt n·ªëi Server';
            }
        }

        async function doRegister() {
            let u = document.getElementById('rUser').value;
            let p = document.getElementById('rPass').value;
            document.getElementById('rMsg').innerText = 'ƒêang x·ª≠ l√Ω...';

            try {
                let res = await fetch('/api/register', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });

                if (res.ok) {
                    alert('ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ƒëƒÉng nh·∫≠p.');
                    toggleForm();
                    document.getElementById('lUser').value = u;
                } else {
                    // 400 th∆∞·ªùng l√† user ƒë√£ t·ªìn t·∫°i
                    document.getElementById('rMsg').innerText = 'T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i ho·∫∑c l·ªói h·ªá th·ªëng.';
                }
            } catch (e) {
                document.getElementById('rMsg').innerText = 'L·ªói k·∫øt n·ªëi Server';
            }
        }

        async function postThought() {
            let title = document.getElementById('bookTitle').value;
            let content = document.getElementById('thoughtContent').value;
            let res = await fetch(`/api/thoughts?token=${localStorage.getItem('token')}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({content: content, book_title: title})
            });
            if (res.ok) { alert('ƒê√£ g·ª≠i!'); searchThoughts(); }
            else alert('L·ªói g·ª≠i b√†i (Token h·∫øt h·∫°n?)');
        }
        
        function logout() { 
            localStorage.removeItem('token'); 
            localStorage.removeItem('user');
            location.reload(); 
        }
        
        searchThoughts(); 
    </script>
</body>
</html>